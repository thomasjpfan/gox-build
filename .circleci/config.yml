build_go: &build_go
  docker:
    - image: docker:18.06.1-ce-git
  environment:
    FULL_IMAGE: $CIRCLE_PROJECT_USERNAME/gox-build:$CIRCLE_BRANCH-$GO_TAG
    DOCKERFILE: Dockerfile-$GO_TAG
  steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Build Image
        command: |
          docker image build -t $FULL_IMAGE -f $DOCKERFILE
    - deploy:
        name: Push to Docker Hub
        command: |
          if [ "$CIRCLE_BRANCH" == "$CIRCLE_TAG" ]; then
            docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
            docker push $FULL_IMAGE
          fi

version: 2
jobs:
  build_go1.11rc2-alpine3.8:
    environment:
      - GO_TAG: 1.11rc2-alpine3.8
    <<: *build_go
